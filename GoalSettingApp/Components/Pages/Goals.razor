@page "/goals"
@attribute [Authorize]
@using GoalSettingApp.Services
@using GoalSettingApp.Extensions
@using GoalSettingApp.Components
@inject GoalService GoalService
@rendermode InteractiveServer

<style>
    .search-container {
        width: 100%;
    }

    .input-mobile {
        max-width: 90%;
    }

    .small-text {
        font-size: .9em;
    }

    @@media (min-width: 768px) {
        .search-container {
            width: 75%;
        }

        .input-mobile {
            width: auto;
            max-width: 9em;
        }
    }
    .goals-container {
        overflow-x: auto;
    }

    .goals-table {
        table-layout: fixed;
        min-width: 1000px;
        width: 100%;
    }

    .col-complete { width: 8%; }
    .col-title { width: 12%; }
    .col-description { width: 21%; }
    .col-category { width: 13%; }
    .col-priority { width: 8%; }
    .col-due { width: 12%; }
    .col-created { width: 12%; }
    .col-actions { width: 14%; }
    
    .text-shortening-cell {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 0;
    }

    .archived-collapse {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease, opacity 0.3s ease;
    }

    .archived-collapse.show {
        max-height: 1500px;
        opacity: 1;
    }

    .archived-table-container {
        min-height: 650px;
    }
</style>

<PageTitle>Goals</PageTitle>

<h1>My Goals</h1>

<div class="search-container d-flex flex-column flex-md-row align-items-start gap-2 ">
    <div class="order-2 mb-1 order-md-1 col-md-3  align-self-start align-self-md-end">
        <button class="btn btn-primary " @onclick="OpenDialog">Add Goal</button>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Title</label>
        <input type="text" class="form-control" @bind="_searchTitle" />
    </div>

    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Category</label>
        <input type="text" class="form-control" @bind="_searchCategory" />
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Priority</label>
        <select class="form-select" @bind="_searchPriority">
            <option value="">All</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-1 align-self-start align-self-md-end">
        <button class="btn btn-primary mt-2 " @onclick="ApplyFilters">
            Search
        </button>
    </div>
</div>

@if (_showDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Goal</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="_newGoalTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="_newGoalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" @bind="_newGoalCategory" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="_newGoalPriority">
                            <option value="@PriorityLevel.Low">Low</option>
                            <option value="@PriorityLevel.Medium">Medium</option>
                            <option value="@PriorityLevel.High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" @bind="_newGoalDueDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recurrence</label>
                        <select class="form-select" @bind="_newGoalRecurrence">
                            <option value="@RecurrenceType.None">None</option>
                            <option value="@RecurrenceType.Daily">Daily</option>
                            <option value="@RecurrenceType.Weekly">Weekly</option>
                            <option value="@RecurrenceType.Monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveAndClose">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@if (_showEditDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Goal</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="_editGoalTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="_editGoalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" @bind="_editGoalCategory" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="_editGoalPriority">
                            <option value="@PriorityLevel.Low">Low</option>
                            <option value="@PriorityLevel.Medium">Medium</option>
                            <option value="@PriorityLevel.High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" @bind="_editGoalDueDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recurrence</label>
                        <select class="form-select" @bind="_editGoalRecurrence">
                            <option value="@RecurrenceType.None">None</option>
                            <option value="@RecurrenceType.Daily">Daily</option>
                            <option value="@RecurrenceType.Weekly">Weekly</option>
                            <option value="@RecurrenceType.Monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEditAndClose">Save</button>
                </div>
            </div>
        </div>
    </div>
}

<div class="mb-4">

</div>

<div>
    <h3>Goals</h3>
    @if (_goals.Count == 0)
    {
        <p><em>No goals yet. Add your first goal above!</em></p>
    }
    else
    {
        <div class="goals-container  border border-rounded-5 p-4">
            <table class="table table-striped goals-table">
                <thead>
                    <tr>
                        <th class="col-complete">Mark Complete</th>
                        <th class="col-title">Title</th>
                        <th class="col-description">Description</th>
                        <th class="col-category">Category</th>
                        <th class="col-priority">Priority</th>
                        <th class="col-due">Due Date</th>
                        <th class="col-created">Created</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var goal in ActiveGoals)
                    {
                        <tr @key="goal.Id" @onclick="() => OpenGoalDetails(goal)" style="cursor: pointer;">
                            <td @onclick:stopPropagation>
                                <input type="checkbox" class="form-check-input" checked="@goal.IsCompleted" @onchange="() => ToggleCompletion(goal.Id, true)" />
                            </td>
                            <td class="table-text col-title text-shortening-cell" title="@goal.Title">
                                @if (goal.IsRecurring)
                                {
                                    <span title="Recurring (@goal.Recurrence)">↻</span>
                                }
                                @goal.Title
                            </td>
                            <td class="col-description text-shortening-cell" title="@goal.Description.FirstCharToUpper()">@goal.Description.FirstCharToUpper()</td>
                            <td class="col-category text-shortening-cell" title="@goal.Category.FirstCharToUpper()">@goal.Category.FirstCharToUpper()</td>
                            <td class="col-priority"><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                            <td class="col-due">@(goal.DueDate?.ToString("MMM d, yyyy") ?? "—")</td>
                            <td class="col-created">@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                            <td class="col-actions" @onclick:stopPropagation>
                                <button class="btn btn-sm btn-warning mb-1 mb-md-1 mb-lg-0"
                                    @onclick="() => StartEdit(goal)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteGoal(goal.Id)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* ARCHIVED GOALS *@
<div class="mb-4">
@if (ArchivedGoals.Any())
{
    <div class="d-flex align-items-center mt-5 gap-3">
        <h3 class="mb-0">Archived Goals (@ArchivedGoals.Count)</h3>
        <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleArchived">
            @(_showArchived ? "Hide" : "View")
        </button>
    </div>

    <div class="archived-collapse @(_showArchived ? "show" : "")">
        <div class="goals-container mt-3">
            <div class="archived-table-container border border-rounded-5 p-4">
                <table class="table table-striped goals-table">
                    <thead>
                        <tr>
                            <th class="col-title">Title</th>
                            <th class="col-description">Description</th>
                            <th class="col-category">Category</th>
                            <th class="col-priority">Priority</th>
                            <th class="col-due">Due Date</th>
                            <th class="col-created">Created</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var goal in PagedArchivedGoals)
                        {
                            <tr class="text-muted" @key="goal.Id">
                                <td class="text-shortening-cell" title="@goal.Title">@goal.Title</td>
                                <td class="text-shortening-cell" title="@goal.Description.FirstCharToUpper()">@goal.Description.FirstCharToUpper()</td>
                                <td class="text-shortening-cell" title="@goal.Category.FirstCharToUpper()">@goal.Category.FirstCharToUpper()</td>
                                <td><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                                <td>@(goal.DueDate?.ToString("MMM d, yyyy") ?? "—")</td>
                                <td>@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary"
                                        @onclick="() => ToggleCompletion(goal.Id, false)">Restore</button>
                                    <button class="btn btn-sm btn-danger"
                                        @onclick="() => DeleteGoal(goal.Id)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <button class="btn btn-sm btn-outline-secondary"
                    disabled="@(_archivedCurrentPage <=1)"
                    @onclick="ArchivedPreviousPage">Previous</button>
                <span>Page @_archivedCurrentPage of @ArchivedTotalPages</span>
                <button class="btn btn-sm btn-outline-secondary"
                    disabled="@(_archivedCurrentPage >= ArchivedTotalPages)"
                    @onclick="ArchivedNextPage">Next</button>
            </div>
        </div>
    </div>
}
</div>

@* === GOAL DETAILS DIALOG === *@
@if (_showGoalDetails && _selectedGoal is not null)
{
    <GoalDialog
        Goal="_selectedGoal"
        OnClose="CloseGoalDetails"
        OnEdit="StartEditFromDialog"
        OnDelete="DeleteFromDialog" />
}

@code {

    private bool _showDialog = false;
    private bool _showArchived = false;
    private bool _showEditDialog = false;
    private void OpenDialog() => _showDialog = true;
    private void CloseDialog() => _showDialog = false;
    private void OpenEditDialog() => _showEditDialog = true;
    private void CloseEditDialog() => _showEditDialog = false;
    private void ToggleArchived() => _showArchived = !_showArchived;
    private List<Goal> _goals = new List<Goal>();

    // New goal fields
    private string _newGoalTitle = "";
    private string _newGoalDescription = "";
    private string _newGoalCategory = "";
    private PriorityLevel _newGoalPriority = PriorityLevel.Medium;
    private DateTime? _newGoalDueDate = DateTime.Today;
    private RecurrenceType _newGoalRecurrence = RecurrenceType.None;

    // Edit goal fields
    private int? _editingGoalId = null;
    private string _editGoalTitle = "";
    private string _editGoalDescription = "";
    private string _editGoalCategory = "";
    private PriorityLevel _editGoalPriority = PriorityLevel.Medium;
    private DateTime? _editGoalDueDate = null;
    private RecurrenceType _editGoalRecurrence = RecurrenceType.None;

    // Search fields
    private string _searchTitle = "";
    private string _searchCategory = "";
    private string _searchPriority = "";

    // Filtered list
    private List<Goal> _filteredGoals = new List<Goal>();
    private List<Goal> ActiveGoals => _filteredGoals.Where(g => !g.IsCompleted).ToList();
    private List<Goal> ArchivedGoals => _filteredGoals.Where(g => g.IsCompleted).ToList();

    // Pagination Variables
    private int _archivedPageSize = 10;
    private int _archivedCurrentPage = 1;
    private int ArchivedTotalPages => (int)Math.Ceiling(ArchivedGoals.Count / (double)_archivedPageSize);
    private List<Goal> PagedArchivedGoals => ArchivedGoals
        .Skip((_archivedCurrentPage - 1) * _archivedPageSize)
        .Take(_archivedPageSize)
        .ToList();

    private void ApplyFilters()
    {
        _filteredGoals = _goals
        .Where(goal =>
        (string.IsNullOrEmpty(_searchTitle) || goal.Title.Contains(_searchTitle, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_searchCategory) || goal.Category.Contains(_searchCategory, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_searchPriority) || goal.Priority.ToString() == _searchPriority)
        )
        .ToList();
    }

    private void ClearFilters()
    {
        _searchTitle = "";
        _searchCategory = "";
        _searchPriority = "";
        _filteredGoals = _goals;
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshGoalsAsync();
    }

    private async Task RefreshGoalsAsync()
    {
        _goals = await GoalService.GetAllGoalsAsync();
        ApplyFilters();
    }

    private async Task AddGoal()
    {
        if (!string.IsNullOrWhiteSpace(_newGoalTitle))
        {
            await GoalService.AddGoalAsync(_newGoalTitle, _newGoalDescription, _newGoalCategory, _newGoalPriority, _newGoalDueDate, _newGoalRecurrence);

            // Clear form
            _newGoalTitle = "";
            _newGoalDescription = "";
            _newGoalCategory = "";
            _newGoalPriority = PriorityLevel.Medium;
            _newGoalDueDate = DateTime.Today;
            _newGoalRecurrence = RecurrenceType.None;

            await RefreshGoalsAsync();
        }
    }

    private async Task SaveEditAndClose()
    {
        if (_editingGoalId.HasValue)
        {
            await SaveEdit(_editingGoalId.Value);
            CloseEditDialog();
        }
    }

    private void StartEdit(Goal goal)
    {
        _editingGoalId = goal.Id;
        _editGoalTitle = goal.Title;
        _editGoalDescription = goal.Description;
        _editGoalCategory = goal.Category;
        _editGoalPriority = goal.Priority;
        _editGoalDueDate = goal.DueDate;
        _editGoalRecurrence = goal.Recurrence;
        OpenEditDialog();
    }

    private async Task SaveEdit(int id)
    {
        await GoalService.EditGoalAsync(id, _editGoalTitle, _editGoalDescription, _editGoalCategory, _editGoalPriority, _editGoalDueDate, _editGoalRecurrence);
        _editingGoalId = null;
        await RefreshGoalsAsync();
    }

    private async Task DeleteGoal(int id)
    {
        await GoalService.DeleteGoalAsync(id);
        await RefreshGoalsAsync();
    }

    private string GetPriorityColor(PriorityLevel priority)
    {
        return priority switch
        {
            PriorityLevel.Low => "secondary",
            PriorityLevel.Medium => "warning",
            PriorityLevel.High => "danger",
            _ => "secondary"
        };
    }

    private async Task SaveAndClose()
    {
        await AddGoal();
        CloseDialog();
    }

    private async Task ToggleCompletion(int id, bool completed)
    {
        await GoalService.ToggleGoalCompletedAsync(id, completed);
        await RefreshGoalsAsync();
    }

    // Archived Goals Navigation
    private void ArchivedPreviousPage()
    {
        if (_archivedCurrentPage > 1)
            _archivedCurrentPage--;
    }

    private void ArchivedNextPage()
    {
        if (_archivedCurrentPage < ArchivedTotalPages)
            _archivedCurrentPage++;
    }

    // Goal Details Dialog
    private Goal? _selectedGoal = null;
    private bool _showGoalDetails = false;

    private void OpenGoalDetails(Goal goal)
    {
        _selectedGoal = goal;
        _showGoalDetails = true;
    }

    private void CloseGoalDetails()
    {
        _showGoalDetails = false;
        _selectedGoal = null;
    }

    private void StartEditFromDialog(Goal goal)
    {
        _showGoalDetails = false;
        StartEdit(goal);
    }

    private async Task DeleteFromDialog(int id)
    {
        _showGoalDetails = false;
        await DeleteGoal(id);
    }

}