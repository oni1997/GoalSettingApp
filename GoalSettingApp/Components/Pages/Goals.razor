@page "/goals"
@attribute [Authorize]
@using GoalSettingApp.Services
@using GoalSettingApp.Extensions
@using GoalSettingApp.Components
@using static GoalSettingApp.Components.ToastNotification
@inject GoalService GoalService
@rendermode InteractiveServer

<style>
    .search-container {
        width: 100%;
        animation: slideIn 0.5s ease;
    }

    .input-mobile {
        max-width: 90%;
    }

    .small-text {
        font-size: .9em;
    }

    @@media (min-width: 768px) {
        .search-container {
            width: 75%;
        }

        .input-mobile {
            width: auto;
            max-width: 9em;
        }
    }

    .goals-container {
        overflow-x: auto;
        animation: fadeIn 0.6s ease;
    }

    .goals-table {
        table-layout: fixed;
        min-width: 1000px;
        width: 100%;
    }

    .col-complete { width: 8%; }
    .col-title { width: 12%; }
    .col-description { width: 21%; }
    .col-category { width: 13%; }
    .col-priority { width: 8%; }
    .col-due { width: 12%; }
    .col-created { width: 12%; }
    .col-actions { width: 14%; }
    
    .text-shortening-cell {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 0;
    }

    .archived-collapse {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease, opacity 0.3s ease;
    }

    .archived-collapse.show {
        max-height: 1500px;
        opacity: 1;
    }

    .archived-table-container {
        min-height: 650px;
    }

    /* Smooth animations */
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Enhanced table row hover */
    .goals-table tbody tr {
        transition: all 0.2s ease;
    }

    .goals-table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05) !important;
        transform: translateX(5px);
    }

    /* Checkbox animation */
    .form-check-input {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .form-check-input:checked {
        animation: checkBounce 0.3s ease;
    }

    @@keyframes checkBounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }

    /* Button improvements */
    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn:active {
        transform: translateY(0);
    }

    /* Loading state */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9998;
        animation: fadeIn 0.2s;
    }

    /* Mobile responsive cards for small screens */
    @@media (max-width: 767px) {
        .goals-table {
            display: none;
        }

        .goal-card {
            display: block !important;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }

        .goal-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
    }

    @@media (min-width: 768px) {
        .goal-card {
            display: none !important;
        }
    }
</style>

<PageTitle>Goals</PageTitle>

<h1>My Goals</h1>

<div class="search-container d-flex flex-column flex-md-row align-items-start gap-2 ">
    <div class="order-2 mb-1 order-md-1 col-md-3  align-self-start align-self-md-end">
        <button class="btn btn-primary " @onclick="OpenDialog">Add Goal</button>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Title</label>
        <input type="text" class="form-control" @bind="_searchTitle" />
    </div>

    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Category</label>
        <input type="text" class="form-control" @bind="_searchCategory" />
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Priority</label>
        <select class="form-select" @bind="_searchPriority">
            <option value="">All</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-1 align-self-start align-self-md-end">
        <button class="btn btn-primary mt-2 " @onclick="ApplyFilters">
            Search
        </button>
    </div>
</div>

@if (_showDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Goal</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="_newGoalTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="_newGoalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" @bind="_newGoalCategory" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="_newGoalPriority">
                            <option value="@PriorityLevel.Low">Low</option>
                            <option value="@PriorityLevel.Medium">Medium</option>
                            <option value="@PriorityLevel.High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" @bind="_newGoalDueDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recurrence</label>
                        <select class="form-select" @bind="_newGoalRecurrence">
                            <option value="@RecurrenceType.None">None</option>
                            <option value="@RecurrenceType.Daily">Daily</option>
                            <option value="@RecurrenceType.Weekly">Weekly</option>
                            <option value="@RecurrenceType.Monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveAndClose">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@if (_showEditDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Goal</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="_editGoalTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="_editGoalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" @bind="_editGoalCategory" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="_editGoalPriority">
                            <option value="@PriorityLevel.Low">Low</option>
                            <option value="@PriorityLevel.Medium">Medium</option>
                            <option value="@PriorityLevel.High">High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" @bind="_editGoalDueDate" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recurrence</label>
                        <select class="form-select" @bind="_editGoalRecurrence">
                            <option value="@RecurrenceType.None">None</option>
                            <option value="@RecurrenceType.Daily">Daily</option>
                            <option value="@RecurrenceType.Weekly">Weekly</option>
                            <option value="@RecurrenceType.Monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEditAndClose">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@* Toast Notification *@
<ToastNotification Message="@_toastMessage"
                   Type="@_toastType"
                   IsVisible="@_showToast"
                   OnHidden="@(() => _showToast = false)" />

@* Confirmation Dialog *@
<ConfirmDialog IsVisible="@_showConfirmDialog"
               Title="@_confirmTitle"
               Message="@_confirmMessage"
               Icon="@_confirmIcon"
               ConfirmText="@_confirmButtonText"
               ConfirmButtonClass="@_confirmButtonClass"
               OnConfirm="@_confirmCallback"
               OnCancel="@(() => _showConfirmDialog = false)" />

@* Loading Overlay *@
@if (_isLoading)
{
    <div class="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

<div class="mb-4">

</div>

<div>
    <h3>Goals</h3>
    @if (_goals.Count == 0)
    {
        <p><em>No goals yet. Add your first goal above!</em></p>
    }
    else
    {
        <div class="goals-container  border border-rounded-5 p-4">
            <table class="table table-striped goals-table">
                <thead>
                    <tr>
                        <th class="col-complete">Mark Complete</th>
                        <th class="col-title">Title</th>
                        <th class="col-description">Description</th>
                        <th class="col-category">Category</th>
                        <th class="col-priority">Priority</th>
                        <th class="col-due">Due Date</th>
                        <th class="col-created">Created</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var goal in ActiveGoals)
                    {
                        <tr @key="goal.Id" @onclick="() => OpenGoalDetails(goal)" style="cursor: pointer;">
                            <td @onclick:stopPropagation>
                                <input type="checkbox" class="form-check-input" checked="@goal.IsCompleted" @onchange="() => ToggleCompletion(goal.Id, true)" />
                            </td>
                            <td class="table-text col-title text-shortening-cell" title="@goal.Title">
                                @if (goal.IsRecurring)
                                {
                                    <span title="Recurring (@goal.Recurrence)">‚Üª</span>
                                }
                                @goal.Title
                            </td>
                            <td class="col-description text-shortening-cell" title="@goal.Description.FirstCharToUpper()">@goal.Description.FirstCharToUpper()</td>
                            <td class="col-category text-shortening-cell" title="@goal.Category.FirstCharToUpper()">@goal.Category.FirstCharToUpper()</td>
                            <td class="col-priority"><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                            <td class="col-due">@(goal.DueDate?.ToString("MMM d, yyyy") ?? "‚Äî")</td>
                            <td class="col-created">@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                            <td class="col-actions" @onclick:stopPropagation>
                                <button class="btn btn-sm btn-warning mb-1 mb-md-1 mb-lg-0"
                                    @onclick="() => StartEdit(goal)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(goal.Id, goal.Title)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @* Mobile Card View *@
        <div class="mobile-cards-container">
            @foreach (var goal in ActiveGoals)
            {
                <div class="goal-card" @key="goal.Id">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="mb-0">@goal.Title</h5>
                        <input type="checkbox" class="form-check-input ms-2" checked="@goal.IsCompleted" 
                               @onchange="() => ToggleCompletion(goal.Id, true)" />
                    </div>
                    <p class="text-muted small mb-2">@goal.Description.FirstCharToUpper()</p>
                    <div class="d-flex gap-2 flex-wrap mb-2">
                        <span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span>
                        <span class="badge bg-secondary">@goal.Category.FirstCharToUpper()</span>
                        <span class="badge bg-info">@(goal.DueDate?.ToString("MMM d, yyyy") ?? "No due date")</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-warning flex-fill" @onclick="() => StartEdit(goal)">Edit</button>
                        <button class="btn btn-sm btn-danger flex-fill" @onclick="() => ConfirmDelete(goal.Id, goal.Title)">Delete</button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@* ARCHIVED GOALS *@
<div class="mb-4">
@if (ArchivedGoals.Any())
{
    <div class="d-flex align-items-center mt-5 gap-3">
        <h3 class="mb-0">Archived Goals (@ArchivedGoals.Count)</h3>
        <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleArchived">
            @(_showArchived ? "Hide" : "View")
        </button>
    </div>

    <div class="archived-collapse @(_showArchived ? "show" : "")">
        <div class="goals-container mt-3">
            <div class="archived-table-container border border-rounded-5 p-4">
                <table class="table table-striped goals-table">
                    <thead>
                        <tr>
                            <th class="col-title">Title</th>
                            <th class="col-description">Description</th>
                            <th class="col-category">Category</th>
                            <th class="col-priority">Priority</th>
                            <th class="col-due">Due Date</th>
                            <th class="col-created">Created</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var goal in PagedArchivedGoals)
                        {
                            <tr class="text-muted" @key="goal.Id">
                                <td class="text-shortening-cell" title="@goal.Title">@goal.Title</td>
                                <td class="text-shortening-cell" title="@goal.Description.FirstCharToUpper()">@goal.Description.FirstCharToUpper()</td>
                                <td class="text-shortening-cell" title="@goal.Category.FirstCharToUpper()">@goal.Category.FirstCharToUpper()</td>
                                <td><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                                <td>@(goal.DueDate?.ToString("MMM d, yyyy") ?? "‚Äî")</td>
                                <td>@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary"
                                        @onclick="() => ToggleCompletion(goal.Id, false)">Restore</button>
                                    <button class="btn btn-sm btn-danger"
                                        @onclick="() => DeleteGoal(goal.Id)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <button class="btn btn-sm btn-outline-secondary"
                    disabled="@(_archivedCurrentPage <=1)"
                    @onclick="ArchivedPreviousPage">Previous</button>
                <span>Page @_archivedCurrentPage of @ArchivedTotalPages</span>
                <button class="btn btn-sm btn-outline-secondary"
                    disabled="@(_archivedCurrentPage >= ArchivedTotalPages)"
                    @onclick="ArchivedNextPage">Next</button>
            </div>
        </div>
    </div>
}
</div>

@* === GOAL DETAILS DIALOG === *@
@if (_showGoalDetails && _selectedGoal is not null)
{
    <GoalDialog
        Goal="_selectedGoal"
        OnClose="CloseGoalDetails"
        OnEdit="StartEditFromDialog"
        OnDelete="DeleteFromDialog" />
}

@code {

    private bool _showDialog = false;
    private bool _showArchived = false;
    private bool _showEditDialog = false;
    private void OpenDialog() => _showDialog = true;
    private void CloseDialog() => _showDialog = false;
    private void OpenEditDialog() => _showEditDialog = true;
    private void CloseEditDialog() => _showEditDialog = false;
    private void ToggleArchived() => _showArchived = !_showArchived;
    private List<Goal> _goals = new List<Goal>();

    // Toast notification fields
    private bool _showToast = false;
    private string _toastMessage = "";
    private ToastType _toastType = ToastType.Info;

    // Confirmation dialog fields
    private bool _showConfirmDialog = false;
    private string _confirmTitle = "";
    private string _confirmMessage = "";
    private string _confirmIcon = "‚ö†Ô∏è";
    private string _confirmButtonText = "Confirm";
    private string _confirmButtonClass = "btn-danger";
    private EventCallback _confirmCallback;
    private int _goalIdToDelete;

    // Loading state
    private bool _isLoading = false;

    // New goal fields
    private string _newGoalTitle = "";
    private string _newGoalDescription = "";
    private string _newGoalCategory = "";
    private PriorityLevel _newGoalPriority = PriorityLevel.Medium;
    private DateTime? _newGoalDueDate = DateTime.Today;
    private RecurrenceType _newGoalRecurrence = RecurrenceType.None;

    // Edit goal fields
    private int? _editingGoalId = null;
    private string _editGoalTitle = "";
    private string _editGoalDescription = "";
    private string _editGoalCategory = "";
    private PriorityLevel _editGoalPriority = PriorityLevel.Medium;
    private DateTime? _editGoalDueDate = null;
    private RecurrenceType _editGoalRecurrence = RecurrenceType.None;

    // Search fields
    private string _searchTitle = "";
    private string _searchCategory = "";
    private string _searchPriority = "";

    // Filtered list
    private List<Goal> _filteredGoals = new List<Goal>();
    private List<Goal> ActiveGoals => _filteredGoals.Where(g => !g.IsCompleted).ToList();
    private List<Goal> ArchivedGoals => _filteredGoals.Where(g => g.IsCompleted).ToList();

    // Pagination Variables
    private int _archivedPageSize = 10;
    private int _archivedCurrentPage = 1;
    private int ArchivedTotalPages => (int)Math.Ceiling(ArchivedGoals.Count / (double)_archivedPageSize);
    private List<Goal> PagedArchivedGoals => ArchivedGoals
        .Skip((_archivedCurrentPage - 1) * _archivedPageSize)
        .Take(_archivedPageSize)
        .ToList();

    private void ApplyFilters()
    {
        _filteredGoals = _goals
        .Where(goal =>
        (string.IsNullOrEmpty(_searchTitle) || goal.Title.Contains(_searchTitle, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_searchCategory) || goal.Category.Contains(_searchCategory, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(_searchPriority) || goal.Priority.ToString() == _searchPriority)
        )
        .ToList();
    }

    private void ClearFilters()
    {
        _searchTitle = "";
        _searchCategory = "";
        _searchPriority = "";
        _filteredGoals = _goals;
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshGoalsAsync();
    }

    private async Task RefreshGoalsAsync()
    {
        _isLoading = true;
        try
        {
            _goals = await GoalService.GetAllGoalsAsync();
            ApplyFilters();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AddGoal()
    {
        if (!string.IsNullOrWhiteSpace(_newGoalTitle))
        {
            await GoalService.AddGoalAsync(_newGoalTitle, _newGoalDescription, _newGoalCategory, _newGoalPriority, _newGoalDueDate, _newGoalRecurrence);

            // Clear form
            _newGoalTitle = "";
            _newGoalDescription = "";
            _newGoalCategory = "";
            _newGoalPriority = PriorityLevel.Medium;
            _newGoalDueDate = DateTime.Today;
            _newGoalRecurrence = RecurrenceType.None;

            await RefreshGoalsAsync();
            ShowToast("Goal created successfully! üéØ", ToastType.Success);
        }
    }

    private async Task SaveEditAndClose()
    {
        if (_editingGoalId.HasValue)
        {
            await SaveEdit(_editingGoalId.Value);
            CloseEditDialog();
        }
    }

    private void StartEdit(Goal goal)
    {
        _editingGoalId = goal.Id;
        _editGoalTitle = goal.Title;
        _editGoalDescription = goal.Description;
        _editGoalCategory = goal.Category;
        _editGoalPriority = goal.Priority;
        _editGoalDueDate = goal.DueDate;
        _editGoalRecurrence = goal.Recurrence;
        OpenEditDialog();
    }

    private async Task SaveEdit(int id)
    {
        await GoalService.EditGoalAsync(id, _editGoalTitle, _editGoalDescription, _editGoalCategory, _editGoalPriority, _editGoalDueDate, _editGoalRecurrence);
        _editingGoalId = null;
        await RefreshGoalsAsync();
        ShowToast("Goal updated successfully! ‚úì", ToastType.Success);
    }

    private void ConfirmDelete(int goalId, string goalTitle)
    {
        _goalIdToDelete = goalId;
        _confirmTitle = "Delete Goal";
        _confirmMessage = $"Are you sure you want to delete '{goalTitle}'? This action cannot be undone.";
        _confirmIcon = "üóëÔ∏è";
        _confirmButtonText = "Delete";
        _confirmButtonClass = "btn-danger";
        _confirmCallback = EventCallback.Factory.Create(this, async () => await DeleteGoal(_goalIdToDelete));
        _showConfirmDialog = true;
    }

    private async Task DeleteGoal(int id)
    {
        _showConfirmDialog = false;
        var success = await GoalService.DeleteGoalAsync(id);
        await RefreshGoalsAsync();
        
        if (success)
        {
            ShowToast("Goal deleted successfully.", ToastType.Success);
        }
        else
        {
            ShowToast("Failed to delete goal. It may not exist.", ToastType.Error);
        }
    }

    private string GetPriorityColor(PriorityLevel priority)
    {
        return priority switch
        {
            PriorityLevel.Low => "secondary",
            PriorityLevel.Medium => "warning",
            PriorityLevel.High => "danger",
            _ => "secondary"
        };
    }

    private async Task SaveAndClose()
    {
        await AddGoal();
        CloseDialog();
    }

    private async Task ToggleCompletion(int id, bool completed)
    {
        var success = await GoalService.ToggleGoalCompletedAsync(id, completed);
        await RefreshGoalsAsync();
        
        if (success)
        {
            var message = completed ? "Goal marked as complete! üéâ" : "Goal restored to active.";
            ShowToast(message, ToastType.Success);
        }
        else
        {
            ShowToast("Failed to update goal status.", ToastType.Error);
        }
    }

    private void ShowToast(string message, ToastType type)
    {
        _toastMessage = message;
        _toastType = type;
        _showToast = true;
        StateHasChanged();
    }

    // Archived Goals Navigation
    private void ArchivedPreviousPage()
    {
        if (_archivedCurrentPage > 1)
            _archivedCurrentPage--;
    }

    private void ArchivedNextPage()
    {
        if (_archivedCurrentPage < ArchivedTotalPages)
            _archivedCurrentPage++;
    }

    // Goal Details Dialog
    private Goal? _selectedGoal = null;
    private bool _showGoalDetails = false;

    private void OpenGoalDetails(Goal goal)
    {
        _selectedGoal = goal;
        _showGoalDetails = true;
    }

    private void CloseGoalDetails()
    {
        _showGoalDetails = false;
        _selectedGoal = null;
    }

    private void StartEditFromDialog(Goal goal)
    {
        _showGoalDetails = false;
        StartEdit(goal);
    }

    private async Task DeleteFromDialog(int id)
    {
        _showGoalDetails = false;
        await DeleteGoal(id);
    }

}