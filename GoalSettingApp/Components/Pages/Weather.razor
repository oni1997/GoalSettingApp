@page "/weather"
@using GoalSettingApp.Services
@using GoalSettingApp.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject WeatherService WeatherService
@inject UserSettingsService UserSettingsService
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

<PageTitle>Weather Forecast</PageTitle>

<h1>Weather Forecast - @(string.IsNullOrEmpty(cityName) ? "Loading..." : cityName)</h1>

<p>5-day weather forecast from OpenWeatherMap API</p>

<!-- City Search Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-6">
                <label class="form-label"><strong>Search for a city:</strong></label>
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Enter city name..."
                           @bind="searchQuery" @bind:event="oninput" @onkeydown="HandleSearchKeyDown" />
                    <button class="btn btn-outline-primary" type="button" @onclick="SearchCities" disabled="@isSearching">
                        @if (isSearching)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }
                        else
                        {
                            <span>Search</span>
                        }
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                @if (!string.IsNullOrEmpty(currentCity))
                {
                    <p class="mb-0 text-muted">
                        <strong>Current city:</strong> @currentCity
                        @if (isAuthenticated)
                        {
                            <span class="badge bg-success ms-2">Saved</span>
                        }
                    </p>
                }
            </div>
        </div>

        @if (searchResults != null && searchResults.Any())
        {
            <div class="mt-3">
                <p class="mb-2"><strong>Search Results:</strong></p>
                <div class="list-group">
                    @foreach (var result in searchResults)
                    {
                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                @onclick="() => SelectCity(result)">
                            <span>@result.DisplayName</span>
                            <span class="badge bg-primary">Select</span>
                        </button>
                    }
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(searchMessage))
        {
            <div class="alert alert-info mt-3 mb-0">@searchMessage</div>
        }
    </div>
</div>

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p><em>Loading weather data...</em></p>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        <strong>Error:</strong> @errorMessage
    </div>
}
else if (dailyForecasts != null && dailyForecasts.Any())
{
    <div class="row mb-3">
        <div class="col-md-12">
            <h4>@cityName, @country</h4>
            <p class="text-muted">Click on a day to see detailed hourly forecast</p>
        </div>
    </div>

    <!-- 5-Day Overview Cards -->
    <div class="row mb-4">
        @foreach (var day in dailyForecasts)
        {
            var isSelected = selectedDay?.Date == day.Date;
            var cardClass = isSelected ? "card border-primary shadow" : "card";
            var cardStyle = isSelected ? "cursor: pointer; background-color: #e7f3ff;" : "cursor: pointer;";

            <div class="col mb-3">
                <div class="@cardClass" style="@cardStyle" @onclick="() => SelectDay(day.Date)">
                    <div class="card-body text-center">
                        <h6 class="card-title">@day.Date.ToString("ddd")</h6>
                        <p class="mb-0 text-muted small">@day.Date.ToString("MMM dd")</p>
                        @if (day.Representative?.Weather != null && day.Representative.Weather.Any())
                        {
                            <img src="@day.Representative.Weather.First().IconUrl" alt="@day.Representative.Weather.First().Description" style="width: 60px;" />
                            <p class="mb-0 small"><strong>@day.Representative.Weather.First().Main</strong></p>
                        }
                        @if (day.Representative?.Main != null)
                        {
                            <p class="mb-0"><strong>@day.MaxTemp.ToString("F0")°C</strong></p>
                            <p class="mb-0 text-muted small">@day.MinTemp.ToString("F0")°C</p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Selected Day Details -->
    @if (selectedDay != null)
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">@selectedDay.Date.ToString("dddd, MMMM dd, yyyy")</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            @if (selectedDay.Representative?.Weather != null && selectedDay.Representative.Weather.Any())
                            {
                                <img src="@selectedDay.Representative.Weather.First().IconUrl" alt="@selectedDay.Representative.Weather.First().Description" style="width: 100px;" />
                                <h4>@selectedDay.Representative.Weather.First().Main</h4>
                                <p class="text-muted">@selectedDay.Representative.Weather.First().Description</p>
                            }
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>High:</strong> @selectedDay.MaxTemp.ToString("F1")°C / @selectedDay.MaxTempF.ToString("F1")°F</p>
                                <p><strong>Low:</strong> @selectedDay.MinTemp.ToString("F1")°C / @selectedDay.MinTempF.ToString("F1")°F</p>
                                <p><strong>Avg Humidity:</strong> @selectedDay.AvgHumidity.ToString("F0")%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Avg Wind Speed:</strong> @selectedDay.AvgWindSpeed.ToString("F1") m/s</p>
                                <p><strong>Avg Pressure:</strong> @selectedDay.AvgPressure.ToString("F0") hPa</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hourly Forecast for Selected Day -->
                <hr />
                <h6 class="mb-3">Hourly Forecast</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Weather</th>
                                <th>Temp (°C)</th>
                                <th>Feels Like</th>
                                <th>Humidity</th>
                                <th>Wind</th>
                                <th>Rain Prob.</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var forecast in selectedDay.HourlyForecasts)
                            {
                                <tr>
                                    <td><strong>@forecast.DateTime.ToString("HH:mm")</strong></td>
                                    <td>
                                        @if (forecast.Weather != null && forecast.Weather.Any())
                                        {
                                            <img src="@forecast.Weather.First().IconUrl" alt="@forecast.Weather.First().Description" style="width: 30px;" />
                                            <span class="small">@forecast.Weather.First().Description</span>
                                        }
                                    </td>
                                    <td>@(forecast.Main != null ? forecast.Main.TempCelsius.ToString("F1") : "N/A")°C</td>
                                    <td>@(forecast.Main != null ? ((forecast.Main.FeelsLike - 273.15).ToString("F1")) : "N/A")°C</td>
                                    <td>@(forecast.Main?.Humidity.ToString() ?? "N/A")%</td>
                                    <td>@(forecast.Wind != null ? forecast.Wind.Speed.ToString("F1") : "N/A") m/s</td>
                                    <td>@((forecast.Pop * 100).ToString("F0"))%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Select a day above to view detailed hourly forecast
        </div>
    }
}
else
{
    <p><em>No weather data available.</em></p>
}

<div class="mt-3">
    <button class="btn btn-primary" @onclick="LoadWeather" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span> Loading...</span>
        }
        else
        {
            <span>Refresh Weather</span>
        }
    </button>
</div>


@code {
    private List<DailyForecast>? dailyForecasts;
    private DailyForecast? selectedDay;
    private bool isLoading = true;
    private string? errorMessage;
    private string cityName = "";
    private string country = "";

    // City search variables
    private string searchQuery = "";
    private List<GeocodingResult>? searchResults;
    private bool isSearching = false;
    private string? searchMessage;
    private string currentCity = "";
    private bool isAuthenticated = false;

    // Current location coordinates
    private double currentLat = -33.9249;
    private double currentLon = 18.4241;
    private string currentCountry = "ZA";

    protected override async Task OnInitializedAsync()
    {
        // Check authentication status
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        // Load user's saved city preference
        await LoadUserSettings();
        await LoadWeather();
    }

    private async Task LoadUserSettings()
    {
        try
        {
            var settings = await UserSettingsService.GetUserSettingsAsync();
            currentLat = settings.PreferredCityLat;
            currentLon = settings.PreferredCityLon;
            currentCity = $"{settings.PreferredCity}, {settings.PreferredCountry}";
            currentCountry = settings.PreferredCountry;
        }
        catch
        {
            // Use default Cape Town if settings can't be loaded
            currentCity = "Cape Town, ZA";
        }
    }

    private async Task SearchCities()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            searchMessage = "Please enter a city name to search.";
            return;
        }

        isSearching = true;
        searchMessage = null;
        searchResults = null;
        StateHasChanged();

        try
        {
            searchResults = await WeatherService.SearchCitiesAsync(searchQuery);

            if (searchResults == null || !searchResults.Any())
            {
                searchMessage = $"No cities found matching '{searchQuery}'.";
            }
        }
        catch (Exception ex)
        {
            searchMessage = $"Error searching for cities: {ex.Message}";
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchCities();
        }
    }

    private async Task SelectCity(GeocodingResult city)
    {
        currentLat = city.Lat;
        currentLon = city.Lon;
        currentCity = city.DisplayName;
        currentCountry = city.Country;
        searchResults = null;
        searchQuery = "";

        // Save preference if user is authenticated
        if (isAuthenticated)
        {
            try
            {
                await UserSettingsService.SavePreferredCityAsync(city.Name, city.Lat, city.Lon, city.Country);
                searchMessage = $"Saved {city.DisplayName} as your preferred city!";
            }
            catch
            {
                searchMessage = "Weather loaded, but couldn't save preference.";
            }
        }
        else
        {
            searchMessage = "Sign in to save your preferred city!";
        }

        await LoadWeather();
    }

    private async Task LoadWeather()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var forecast = await WeatherService.GetForecastAsync(currentLat, currentLon);

            if (forecast?.List != null)
            {
                // Group forecasts by day
                dailyForecasts = forecast.List
                    .GroupBy(f => f.DateTime.Date)
                    .Select(g => new DailyForecast
                    {
                        Date = g.Key,
                        HourlyForecasts = g.OrderBy(f => f.DateTime).ToList(),
                        Representative = g.OrderBy(f => Math.Abs((f.DateTime.Hour - 12))).First(),
                        MaxTemp = g.Max(f => f.Main?.TempCelsius ?? 0),
                        MinTemp = g.Min(f => f.Main?.TempCelsius ?? 0),
                        AvgHumidity = g.Average(f => f.Main?.Humidity ?? 0),
                        AvgWindSpeed = g.Average(f => f.Wind?.Speed ?? 0),
                        AvgPressure = g.Average(f => f.Main?.Pressure ?? 0)
                    })
                    .Take(5)
                    .ToList();

                cityName = forecast.City?.Name ?? "Unknown";
                country = forecast.City?.Country ?? "";

                // Auto-select first day
                if (dailyForecasts.Any())
                {
                    selectedDay = dailyForecasts.First();
                }
            }
            else
            {
                errorMessage = "No weather data received from the API.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load weather data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectDay(DateTime date)
    {
        selectedDay = dailyForecasts?.FirstOrDefault(d => d.Date == date);
    }

    private class DailyForecast
    {
        public DateTime Date { get; set; }
        public List<WeatherData> HourlyForecasts { get; set; } = new();
        public WeatherData? Representative { get; set; }
        public double MaxTemp { get; set; }
        public double MinTemp { get; set; }
        public double AvgHumidity { get; set; }
        public double AvgWindSpeed { get; set; }
        public double AvgPressure { get; set; }

        public double MaxTempF => (MaxTemp * 9 / 5) + 32;
        public double MinTempF => (MinTemp * 9 / 5) + 32;
    }
}