@page "/signup"
@attribute [AllowAnonymous]
@layout LoginLayout
@using GoalSettingApp.Components.Layout
@using GoalSettingApp.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Supabase.Gotrue
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Routing
@using GoalSettingApp.Models

@inject Supabase.Client Supabase
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider


<PageTitle>Sign Up</PageTitle>

<div class="px-4 bg-light border rounded d-flex py-2 mb-3">
    <h3>Sign Up</h3>
</div>

<EditForm Model="@signUpModel" OnValidSubmit="@HandleSignUp" FormName="SignUpForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="name" class="form-label">Name</label>
        <InputText id="name" class="form-control" @bind-Value="signUpModel.Name" />
        <ValidationMessage For="@(() => signUpModel.Name)"/>
    </div>

    <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <InputText id="email" class="form-control" @bind-Value="signUpModel.Email" />
        <ValidationMessage For="@(() => signUpModel.Email)"/>
    </div>

    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <InputText id="password" type="password" class="form-control" @bind-Value="signUpModel.Password" />
        <ValidationMessage For="@(() => signUpModel.Password)" />
    </div>
    <button type="submit" class="btn btn-primary mb-3" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status"></span>
            <span> Signing up...</span>
        }
        else
        {
            <span>Sign Up</span>
        }
    </button>
</EditForm>
<p>Already have an account? <NavLink href="login"><span>Sign in here</span></NavLink></p>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @AlertClass mt-3">@Message</div>
}

@code {
    [SupplyParameterFromForm]
    private SignUpModel signUpModel { get; set; } = new();
    private bool isLoading = false;
    private string Message = "";
    private string AlertClass = "";

    private async Task HandleSignUp()
    {
        isLoading = true;
        Message = "";
        StateHasChanged();

        try
        {
            var session = await Supabase.Auth.SignUp(signUpModel.Email, signUpModel.Password, new Supabase.Gotrue.SignUpOptions
            {
                Data = new Dictionary<string, object>
                {
                    { "display_name", signUpModel.Name }
                }
            });

            if (session?.User?.ConfirmedAt != null)
            {
                await Supabase.Auth.SignIn(signUpModel.Email, signUpModel.Password);
                ((SupabaseAuthenticationStateProvider)AuthStateProvider).NotifyAuthenticationStateChanged();
                Navigation.NavigateTo("/");
            }
            else
            {
                Message = "Sign-up successful! Please check your email to confirm your account.";
                AlertClass = "alert-success";
            }
        }
        catch (Microsoft.AspNetCore.Components.NavigationException)
        {
            throw;
        }
        catch (Exception ex)
        {
            Message = $"Error: {ex.Message}";
            AlertClass = "alert-danger";
        }

        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}