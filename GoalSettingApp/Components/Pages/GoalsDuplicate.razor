@page "/goalsduplicate"
@attribute [Authorize]
@using GoalSettingApp.Services
@using GoalSettingApp.Extensions
@inject GoalService GoalService
@rendermode InteractiveServer

<style>
    .search-container {
        width: 100%;
    }

    .input-mobile {
        width: 90%;
    }

    @@media (min-width: 768px) {
        .search-container {
            width: 75%;
        }

        .input-mobile {
            width: auto;
            max-width: 9em;
        }
    }
</style>

<PageTitle>Goals</PageTitle>

<h1>My Goals</h1>

<div class="search-container d-flex flex-column flex-md-row align-items-start gap-2">
    <div class="order-2 mb-1 order-md-1 col-md-3  align-self-start align-self-md-end">
        <button class="btn btn-primary " @onclick="OpenDialog">Add Goal</button>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Title</label>
        <input type="text" class="form-control" @bind="searchTitle" />
    </div>

    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Category</label>
        <input type="text" class="form-control" @bind="searchCategory" />
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-3 input-mobile">
        <label class="form-label">Priority</label>
        <select class="form-select" @bind="searchPriority">
            <option value="">All</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>
    </div>
    <div class="order-1 mb-1 order-md-2 col-md-4 align-self-start align-self-md-end">
        <button class="btn btn-primary mt-2 " @onclick="ApplyFilters">
            Search
        </button>
    </div>
</div>

@if (showDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Goal</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="newGoalTitle" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" @bind="newGoalDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" @bind="newGoalCategory" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" @bind="newGoalPriority">
                            <option value="@PriorityLevel.Low">Low</option>
                            <option value="@PriorityLevel.Medium">Medium</option>
                            <option value="@PriorityLevel.High">High</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveAndClose">Save</button>
                </div>
            </div>
        </div>
    </div>
}

<div class="mb-4">

</div>

<div>
    <h3>Goal List</h3>
    @if (goals.Count == 0)
    {
        <p><em>No goals yet. Add your first goal above!</em></p>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var goal in filteredGoals)
                    {
                        <tr>
                            @if (editingGoalId == goal.Id)
                            {
                                <td><input type="text" class="form-control" @bind="editGoalTitle" /></td>
                                <td><textarea class="form-control" @bind="editGoalDescription"></textarea></td>
                                <td><input type="text" class="form-control" @bind="editGoalCategory" /></td>
                                <td>
                                    <select class="form-select" @bind="editGoalPriority">
                                        <option value="@PriorityLevel.Low">Low</option>
                                        <option value="@PriorityLevel.Medium">Medium</option>
                                        <option value="@PriorityLevel.High">High</option>
                                    </select>
                                </td>
                                <td>@goal.CreatedAt.ToShortDateString()</td>
                                <td class="d-flex">
                                    <button class="btn btn-sm btn-success mb-1 mb-md-0"
                                        @onclick="() => SaveEdit(goal.Id)">Save</button>
                                    <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Cancel</button>
                                </td>
                            }
                            else
                            {
                                <td>@goal.Title</td>
                                <td>@goal.Description.FirstCharToUpper()</td>
                                <td>@goal.Category.FirstCharToUpper()</td>
                                <td><span class="badge bg-@GetPriorityColor(goal.Priority)">@goal.Priority</span></td>
                                <td>@goal.CreatedAt.ToString("MMM d, yyyy")</td>
                                <td>
                                    <button class="btn btn-sm btn-warning mb-1 mb-md-1 mb-lg-0"
                                        @onclick="() => StartEdit(goal)">Edit</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteGoal(goal.Id)">Delete</button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {

    private bool showDialog = false;

    private void OpenDialog() => showDialog = true;
    private void CloseDialog() => showDialog = false;
    private List<Goal> goals = new List<Goal>();

    // New goal fields
    private string newGoalTitle = "";
    private string newGoalDescription = "";
    private string newGoalCategory = "";
    private PriorityLevel newGoalPriority = PriorityLevel.Medium;

    // Edit goal fields
    private int? editingGoalId = null;
    private string editGoalTitle = "";
    private string editGoalDescription = "";
    private string editGoalCategory = "";
    private PriorityLevel editGoalPriority = PriorityLevel.Medium;

    // Search fields
    private string searchTitle = "";
    private string searchCategory = "";
    private string searchPriority = "";

    // Filtered list
    private List<Goal> filteredGoals = new List<Goal>();

    private void ApplyFilters()
    {
        filteredGoals = goals
        .Where(goal =>
        (string.IsNullOrEmpty(searchTitle) || goal.Title.Contains(searchTitle, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(searchCategory) || goal.Category.Contains(searchCategory, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrEmpty(searchPriority) || goal.Priority.ToString() == searchPriority)
        )
        .ToList();
    }

    private void ClearFilters()
    {
        searchTitle = "";
        searchCategory = "";
        searchPriority = "";
        filteredGoals = goals;
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshGoalsAsync();
    }

    private async Task RefreshGoalsAsync()
    {
        goals = await GoalService.GetAllGoalsAsync();
        ApplyFilters();
    }

    private async Task AddGoal()
    {
        if (!string.IsNullOrWhiteSpace(newGoalTitle))
        {
            await GoalService.AddGoalAsync(newGoalTitle, newGoalDescription, newGoalCategory, newGoalPriority);

            // Clear form
            newGoalTitle = "";
            newGoalDescription = "";
            newGoalCategory = "";
            newGoalPriority = PriorityLevel.Medium;

            await RefreshGoalsAsync();
        }
    }

    private void StartEdit(Goal goal)
    {
        editingGoalId = goal.Id;
        editGoalTitle = goal.Title;
        editGoalDescription = goal.Description;
        editGoalCategory = goal.Category;
        editGoalPriority = goal.Priority;
    }

    private async Task SaveEdit(int id)
    {
        await GoalService.EditGoalAsync(id, editGoalTitle, editGoalDescription, editGoalCategory, editGoalPriority);
        editingGoalId = null;
        await RefreshGoalsAsync();
    }

    private void CancelEdit()
    {
        editingGoalId = null;
    }

    private async Task DeleteGoal(int id)
    {
        await GoalService.DeleteGoalAsync(id);
        await RefreshGoalsAsync();
    }

    private string GetPriorityColor(PriorityLevel priority)
    {
        return priority switch
        {
            PriorityLevel.Low => "secondary",
            PriorityLevel.Medium => "warning",
            PriorityLevel.High => "danger",
            _ => "secondary"
        };
    }

    private async Task SaveAndClose()
    {
        await AddGoal();
        CloseDialog();
    }
}